#!/usr/bin/env node
const program = require('commander')
const axios = require('axios')
const homedir = require('os').homedir()
const fs = require('fs')
const path = require('path')
const ora = require('ora')
const chalk = require('chalk')

program
  .option('-n, --issueNo', '只能拉取指定的issue')
  .parse(process.argv)

const config =JSON.parse(fs.readFileSync(path.join(homedir, '.issue.json'), 'utf-8'))

const getIssue = (issueNo = '') => {
  const spinner = ora('start pull issue...').start()
  // https://developer.github.com/v3/issues/#list-issues-for-a-repository
  axios({
    methods: 'get',
    headers: { 'content-type': 'application/vnd.github.VERSION.raw+json' },
    url: `https://api.github.com/repos/${config.username}/${config.repo}/issues${issueNo ? '/'+ issueNo : ''}`,
    params: {
      state: config.pullType
    }
  }).then(docs => {
    let issueList = issueNo ? [docs.data] : docs.data
    for (const doc of issueList) {
      spinner.text = `pull ${doc.title}...` 
      try {
        fs.writeFileSync(path.join(process.cwd(), `${doc.title}.md`), doc.body)
        spinner.succeed(`${doc.title} pull succeed！`)
      } catch (error) {
        spinner.fail(`${doc.title} pull failed`)
        console.log(chalk.red(error))
      }
    }
  }, err => {
    spinner.stop()
    console.log(chalk.red(err))
  })
}

// 获取所有的issue
if (!program.args[0]) {
  getIssue()
} else {
  // 获取指定的issue
  const issueNo = program.args.map(no => {
    if (!Number.isNaN(Number(no))) {
      return Number(no)
    }
  })

  if (!issueNo.length) {
    console.error(chalk.red('请输入正确的issue的标号'))
    return
  }
  
  getIssue(issueNo)
}
